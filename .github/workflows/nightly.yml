name: Nightly Build

on:
  schedule:
    - cron: '0 2 * * *' # 2 AM daily
  workflow_dispatch: # Manual trigger for the rizz

permissions:
  contents: write

jobs:
  tag:
    name: Create Nightly Tag
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
      - name: Update Nightly Tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -f nightly
          git push -f origin nightly

  dist:
    name: Build & Release
    needs: tag
    if: github.ref == 'refs/heads/main'
    strategy:
      matrix:
        include:
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
          - target: x86_64-pc-windows-msvc
            os: windows-latest
          - target: x86_64-apple-darwin
            os: macos-latest
          - target: aarch64-apple-darwin
            os: macos-latest
    runs-on: ${{ matrix.os }}
    steps:
      - uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      
      - name: Install cargo-dist
        shell: bash
        run: curl --proto '=https' --tlsv1.2 -LsSf https://github.com/axodotdev/cargo-dist/releases/download/v0.30.3/cargo-dist-installer.sh | sh

      - name: Run cargo-dist build
        shell: bash
        run: cargo dist build --target=${{ matrix.target }}

      - name: Upload Artifacts to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          files: target/distrib/*
          prerelease: true
          name: "Nightly Build (Live on the edge üçî)"
          body: |
            This is an automated nightly build of the Holtburger TUI client.
            Built on: ${{ github.event.repository.updated_at }}
            Commit: ${{ github.sha }}
            
            **Warning:** These builds are highly experimental!
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  flatpak:
    name: Build Flatpak
    needs: tag
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    container:
      image: ghcr.io/flathub-infra/flatpak-github-actions:gnome-48
      options: --privileged
    steps:
      - uses: actions/checkout@v4
      - uses: flatpak/flatpak-github-actions/flatpak-builder@v6
        with:
          bundle: holtburger-cli.flatpak
          manifest-path: apps/holtburger-cli/dist/io.github.merklejerk.holtburger-cli.yaml
          cache: true
          run-tests: true # This is the "secret sauce" to enable network access during build
      - name: Upload Flatpak to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly
          files: holtburger-cli.flatpak
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
